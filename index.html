<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Máquinas Automáticas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --green: #27ae60;
            --red: #e74c3c;
            --yellow: #f39c12;
            --light-success: rgba(39, 174, 96, 0.1);
            --light-danger: rgba(231, 76, 60, 0.1);
            --light-bg: #f8f9fa;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--secondary);
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-title i {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .header-subtitle {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
        }

        .header-info {
            font-size: 0.9rem;
            text-align: right;
        }

        .header-date {
            font-size: 0.8rem;
            opacity: 0.8;
            text-align: right;
        }

        .tabs {
            display: flex;
            margin-top: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 500;
            color: #fff;
        }

        .tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            border-bottom-color: var(--primary);
            background-color: rgba(52, 152, 219, 0.2);
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .export-btn {
            background-color: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background-color: #2980b9;
        }

        .machines-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .machine-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .machine-header {
            padding: 15px;
            background-color: var(--secondary);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .machine-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .machine-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-operational {
            background-color: var(--green);
        }

        .status-partial {
            background-color: var(--yellow);
        }

        .status-critical {
            background-color: var(--red);
        }

        .machine-toggle {
            background-color: transparent;
            border: 2px solid #fff;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .machine-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .machine-toggle.active {
            background-color: var(--green);
            border-color: var(--green);
        }

        .machine-body {
            padding: 20px;
            display: none;
        }

        .machine-body.active {
            display: block;
        }

        .segment-machine {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .segment-svg {
            margin-bottom: 20px;
        }

        .segment {
            cursor: pointer;
            transition: var(--transition);
        }

        .segment:hover {
            opacity: 0.8;
        }

        .segment.active {
            fill: var(--green);
        }

        .segment.inactive {
            fill: #ddd;
        }

        .vibration-center {
            cursor: pointer;
            transition: var(--transition);
        }

        .vibration-center.active {
            fill: var(--green);
        }

        .vibration-center.inactive {
            fill: #ddd;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .device-box {
            padding: 15px;
            border: 2px solid var(--primary);
            background-color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .device-box:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .device-box.active {
            background-color: var(--green);
            color: #fff;
            border-color: var(--green);
        }

        .device-box.inactive {
            background-color: var(--red);
            color: #fff;
            border-color: var(--red);
        }

        .device-box i {
            font-size: 1.5rem;
        }

        .parts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .part-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background-color: #fff;
            transition: var(--transition);
        }

        .part-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .part-name {
            font-weight: 600;
        }

        .part-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .part-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .part-device {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            border-radius: 4px;
            background-color: var(--light-bg);
        }

        .device-toggle {
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .device-toggle.active {
            background-color: var(--green);
        }

        .device-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #fff;
            top: 2px;
            left: 2px;
            transition: var(--transition);
        }

        .device-toggle.active::after {
            left: 22px;
        }

        .simple-machine {
            text-align: center;
            padding: 20px;
        }

        .simple-status {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .simple-toggle {
            padding: 10px 20px;
            background-color: var(--primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .simple-toggle:hover {
            background-color: #2980b9;
        }

        .simple-toggle.active {
            background-color: var(--green);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            background-color: var(--secondary);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            background-color: #fff;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--green);
            color: #fff;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: var(--red);
            color: #fff;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .spare-parts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .spare-parts-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--secondary);
        }

        .add-spare-btn {
            background-color: var(--green);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-spare-btn:hover {
            background-color: #229954;
        }

        .spare-parts-list {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .spare-list-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 180px;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary);
            color: #fff;
            font-weight: 600;
        }

        .spare-list-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 180px;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .spare-list-item:last-child {
            border-bottom: none;
        }

        .spare-list-item:hover {
            background-color: var(--light-bg);
        }

        .spare-name {
            font-weight: 600;
        }

        .spare-compatibility {
            color: #666;
        }

        .quantity-badge {
            background-color: var(--primary);
            color: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            display: inline-block;
        }

        .quantity-badge.low {
            background-color: var(--red);
        }

        .quantity-badge.medium {
            background-color: var(--yellow);
        }

        .spare-actions {
            display: flex;
            gap: 10px;
        }

        .edit-spare-btn, .add-stock-btn, .delete-spare-btn {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .edit-spare-btn:hover, .add-stock-btn:hover {
            background-color: var(--primary);
            color: #fff;
        }

        .delete-spare-btn {
            border-color: var(--red);
            color: var(--red);
        }

        .delete-spare-btn:hover {
            background-color: var(--red);
            color: #fff;
        }

        .image-upload-container {
            margin-bottom: 15px;
        }

        .image-upload-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .image-upload-area i {
            font-size: 2rem;
            color: #999;
            margin-bottom: 10px;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        .history-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .history-header {
            padding: 15px 20px;
            background-color: var(--secondary);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .history-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .history-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-filter label {
            font-size: 0.9rem;
        }

        .date-filter input {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .date-filter input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .clear-filter-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .clear-filter-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .filter-select {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .filter-select option {
            background-color: var(--secondary);
        }

        .history-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .history-item:hover {
            background-color: var(--light-bg);
        }

        .history-item.success {
            background-color: var(--light-success);
        }

        .history-item.danger {
            background-color: var(--light-danger);
        }

        .history-date {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .history-machine {
            font-weight: 600;
        }

        .history-component {
            color: #666;
            font-size: 0.9rem;
        }

        .history-action {
            color: #555;
            font-size: 0.9rem;
        }

        .history-reason {
            color: #777;
            font-size: 0.9rem;
            font-style: italic;
        }

        .history-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.repair {
            background-color: var(--primary);
            color: #fff;
        }

        .status-badge.failure {
            background-color: var(--red);
            color: #fff;
        }

        .status-badge.maintenance {
            background-color: var(--yellow);
            color: #fff;
        }

        .expand-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .history-expanded {
            display: none;
            padding: 15px 20px;
            background-color: var(--light-bg);
            border-top: 1px solid #eee;
        }

        .history-expanded.active {
            display: block;
        }

        .expanded-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .expanded-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .expanded-label {
            font-weight: 500;
            color: #666;
            font-size: 0.9rem;
        }

        .expanded-value {
            color: #333;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification.success .notification-icon {
            color: var(--green);
        }

        .notification.error .notification-icon {
            color: var(--red);
        }

        .notification.warning .notification-icon {
            color: var(--yellow);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 0.9rem;
            color: #555;
        }

        .notification-close {
            background: none;
            border: none;
            color: #777;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .machines-container, .spare-parts-list, .device-grid, .parts-grid, .expanded-content {
                grid-template-columns: 1fr;
            }
            
            .spare-list-header, .spare-list-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .header-content {
                gap: 10px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .history-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-filters {
                width: 100%;
            }
            
            .date-filter {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Component Action Modal -->
    <div class="modal" id="componentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Acción de Componente</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="componentForm">
                    <div class="form-group">
                        <label class="form-label" for="componentName">Componente</label>
                        <input type="text" class="form-control" id="componentName" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="actionType">Tipo de Acción</label>
                        <select class="form-select" id="actionType">
                            <option value="maintenance">Mantenimiento</option>
                            <option value="repair">Reparación</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reason">Motivo</label>
                        <textarea class="form-control" id="reason" rows="3" placeholder="Describe el motivo de la acción"></textarea>
                    </div>
                    <div class="form-group" id="sparePartsGroup">
                        <label class="form-label" for="spareParts">Repuestos Utilizados</label>
                        <select class="form-select" id="spareParts">
                            <option value="">Ninguno</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Spare Part Modal -->
    <div class="modal" id="sparePartModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="spareModalTitle">Nuevo Repuesto</div>
                <button class="modal-close" id="spareModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sparePartForm">
                    <div class="form-group">
                        <label class="form-label" for="spareDescription">Descripción</label>
                        <input type="text" class="form-control" id="spareDescription" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="spareCompatibility">Compatibilidad</label>
                        <select class="form-select" id="spareCompatibility" required>
                            <option value="">Seleccionar compatibilidad</option>
                            <option value="S/T/U">S/T/U</option>
                            <option value="R">R</option>
                            <option value="W">W</option>
                            <option value="Máq Bolsas">Máq Bolsas</option>
                            <option value="Alineador Mag">Alineador Mag</option>
                            <option value="Sist Neumáticos">Sist Neumáticos</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="spareQuantity">Cantidad</label>
                        <input type="number" class="form-control" id="spareQuantity" min="0" required>
                    </div>
                    <div class="image-upload-container">
                        <label class="image-upload-label">Imagen del Repuesto</label>
                        <div class="image-upload-area" id="imageUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Haz clic para subir una imagen</p>
                            <input type="file" id="spareImageInput" accept="image/*" style="display:none">
                        </div>
                        <div class="image-preview" id="imagePreview" style="display:none">
                            <img id="previewImage" src="" alt="Vista previa">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="spareCancelBtn">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="spareSaveBtn">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Stock Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="stockModalTitle">Añadir Stock</div>
                <button class="modal-close" id="stockModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="form-group">
                        <label class="form-label" for="stockSpareName">Repuesto</label>
                        <input type="text" class="form-control" id="stockSpareName" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="stockCurrentQuantity">Cantidad Actual</label>
                        <input type="number" class="form-control" id="stockCurrentQuantity" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="stockAddQuantity">Cantidad a Añadir</label>
                        <input type="number" class="form-control" id="stockAddQuantity" min="1" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="stockCancelBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'https://pcma01.onrender.com';

        let authToken = localStorage.getItem('authToken');

        // Application State
        const state = {
            machines: {
                S: {
                    id: 'S',
                    name: 'Máquina S',
                    type: 'SEGMENT_BASED',
                    operational: true,
                    segments: Array.from({length: 28}, (_, i) => ({
                        id: i < 14 ? `F${i+1}` : `W${i-13}`,
                        active: true
                    })),
                    vibrationPump: {
                        active: true
                    }
                },
                R: {
                    id: 'R',
                    name: 'Máquina R',
                    type: 'SEGMENT_BASED',
                    operational: true,
                    segments: Array.from({length: 28}, (_, i) => ({
                        id: i < 14 ? `F${i+1}` : `W${i-13}`,
                        active: true
                    })),
                    vibrationPump: {
                        active: true
                    }
                },
                T: {
                    id: 'T',
                    name: 'Máquina T',
                    type: 'SEGMENT_BASED',
                    operational: true,
                    segments: Array.from({length: 28}, (_, i) => ({
                        id: i < 14 ? `F${i+1}` : `W${i-13}`,
                        active: true
                    })),
                    vibrationPump: {
                        active: true
                    }
                },
                U: {
                    id: 'U',
                    name: 'Máquina U',
                    type: 'SEGMENT_BASED',
                    operational: true,
                    segments: Array.from({length: 28}, (_, i) => ({
                        id: i < 14 ? `F${i+1}` : `W${i-13}`,
                        active: true
                    })),
                    vibrationPump: {
                        active: true
                    }
                },
                W: {
                    id: 'W',
                    name: 'Máquina W',
                    type: 'SEGMENT_BASED',
                    operational: true,
                    segments: Array.from({length: 28}, (_, i) => ({
                        id: i < 14 ? `F${i+1}` : `W${i-13}`,
                        active: true
                    })),
                    vibrationPump: {
                        active: true
                    }
                },
                bolsas: {
                    id: 'bolsas',
                    name: 'Máquina de Bolsas',
                    type: 'DEVICE_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuchillo', name: 'Cuchillo', active: true },
                        { id: 'impresora', name: 'Impresora', active: true },
                        { id: 'neumatico', name: 'Neumático', active: true },
                        { id: 'insumos', name: 'Insumos', active: true }
                    ]
                },
                alineador: {
                    id: 'alineador',
                    name: 'Alineador',
                    type: 'SIMPLE',
                    operational: true
                },
                'neumaticos-s': {
                    id: 'neumaticos-s',
                    name: 'Neumáticos S',
                    type: 'GRID_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuerpo-control', name: 'Cuerpo de Control', active: true },
                        { id: 'ev', name: 'EV', active: true },
                        { id: 'generador-vacio', name: 'Generador de Vacío', active: true },
                        { id: 'tubing', name: 'Tubing', active: true }
                    ]
                },
                'neumaticos-r': {
                    id: 'neumaticos-r',
                    name: 'Neumáticos R',
                    type: 'GRID_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuerpo-control', name: 'Cuerpo de Control', active: true },
                        { id: 'ev', name: 'EV', active: true },
                        { id: 'generador-vacio', name: 'Generador de Vacío', active: true },
                        { id: 'tubing', name: 'Tubing', active: true }
                    ]
                },
                'neumaticos-t': {
                    id: 'neumaticos-t',
                    name: 'Neumáticos T',
                    type: 'GRID_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuerpo-control', name: 'Cuerpo de Control', active: true },
                        { id: 'ev', name: 'EV', active: true },
                        { id: 'generador-vacio', name: 'Generador de Vacío', active: true },
                        { id: 'tubing', name: 'Tubing', active: true }
                    ]
                },
                'neumaticos-u': {
                    id: 'neumaticos-u',
                    name: 'Neumáticos U',
                    type: 'GRID_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuerpo-control', name: 'Cuerpo de Control', active: true },
                        { id: 'ev', name: 'EV', active: true },
                        { id: 'generador-vacio', name: 'Generador de Vacío', active: true },
                        { id: 'tubing', name: 'Tubing', active: true }
                    ]
                },
                'neumaticos-w': {
                    id: 'neumaticos-w',
                    name: 'Neumáticos W',
                    type: 'GRID_BASED',
                    operational: true,
                    devices: [
                        { id: 'cuerpo-control', name: 'Cuerpo de Control', active: true },
                        { id: 'ev', name: 'EV', active: true },
                        { id: 'generador-vacio', name: 'Generador de Vacío', active: true },
                        { id: 'tubing', name: 'Tubing', active: true }
                    ]
                }
            },
            spareParts: [],
            history: [],
            currentComponent: null,
            currentSparePart: null,
            editSparePart: false
        };

        // Authentication functions
        async function login(password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    return true;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Login error:', error);
                return false;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showLoginScreen();
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            if (response.status === 401 || response.status === 403) {
                logout();
                return null;
            }
            
            if (!response.ok) {
                throw new Error('API call failed');
            }
            
            return await response.json();
        }

        // Login screen
        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f5f7fa;">
                    <div style="background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; min-width: 300px;">
                        <h2 style="margin-bottom: 20px; color: #2c3e50;">Panel de Control</h2>
                        <p style="margin-bottom: 20px; color: #666;">Ingrese la contraseña para continuar</p>
                        <input type="password" id="passwordInput" placeholder="Contraseña" 
                            style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        <button onclick="attemptLogin()" 
                            style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Ingresar
                        </button>
                        <div id="loginError" style="color: #e74c3c; margin-top: 10px; display: none;">Contraseña incorrecta</div>
                    </div>
                </div>
            `;
            
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
        }

        async function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            const success = await login(password);
            
            if (success) {
                location.reload();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Main app content
        function showMainApp() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <header>
                        <div class="header-content">
                            <div class="header-title">
                                <i class="fas fa-cogs"></i>
                                <h1>Panel de Control de Máquinas Automáticas</h1>
                            </div>
                            <div class="header-subtitle">
                                <div class="header-info">PC.MA-01 rev 1 - 21/10/2025</div>
                                <div class="header-date" id="currentDate"></div>
                                <button class="export-btn" onclick="logout()" style="margin-left: 10px;">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </button>
                            </div>
                            <div class="tabs">
                                <div class="tab active" data-tab="estado">Estado</div>
                                <div class="tab" data-tab="repuestos">Repuestos</div>
                                <div class="tab" data-tab="historicos">Históricos</div>
                            </div>
                        </div>
                    </header>
                    
                    <main>
                        <div class="tab-content active" id="estado-tab">
                            <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
                                <button class="export-btn" id="exportPdfBtn">
                                    <i class="fas fa-file-pdf"></i>Exportar Estado
                                </button>
                            </div>
                            <div class="machines-container" id="machinesContainer"></div>
                        </div>
                        
                        <div class="tab-content" id="repuestos-tab">
                            <div class="spare-parts-header">
                                <div class="spare-parts-title">Gestión de Repuestos</div>
                                <button class="add-spare-btn" id="addSparePartBtn">
                                    <i class="fas fa-plus"></i>Nuevo Repuesto
                                </button>
                            </div>
                            <div class="spare-parts-list" id="sparePartsContainer">
                                <div class="spare-list-header">
                                    <div>Descripción</div>
                                    <div>Compatibilidad</div>
                                    <div>Stock</div>
                                    <div>Imagen</div>
                                    <div>Acciones</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="historicos-tab">
                            <div class="history-container">
                                <div class="history-header">
                                    <div class="history-title">Historial de Mantenimiento</div>
                                    <div class="history-filters">
                                        <div class="date-filter">
                                            <label for="startDate">Desde:</label>
                                            <input type="date" id="startDate" placeholder="Fecha inicial">
                                            <label for="endDate">Hasta:</label>
                                            <input type="date" id="endDate" placeholder="Fecha final">
                                            <button class="clear-filter-btn" id="clearDateFilter">
                                                <i class="fas fa-times"></i> Limpiar
                                            </button>
                                        </div>
                                        <select class="filter-select" id="machineFilter">
                                            <option value="all">Todas las máquinas</option>
                                        </select>
                                        <select class="filter-select" id="actionFilter">
                                            <option value="all">Todas las acciones</option>
                                            <option value="repair">Reparación</option>
                                            <option value="maintenance">Mantenimiento</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="history-list" id="historyList"></div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            // Initialize all event listeners and components
            initializeApp();
        }

        // Initialize app components
        function initializeApp() {
            // Get all DOM elements
            const machinesContainer = document.getElementById('machinesContainer');
            const sparePartsContainer = document.getElementById('sparePartsContainer');
            const historyList = document.getElementById('historyList');
            const componentModal = document.getElementById('componentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalClose = document.getElementById('modalClose');
            const componentForm = document.getElementById('componentForm');
            const cancelBtn = document.getElementById('cancelBtn');
            const componentName = document.getElementById('componentName');
            const actionType = document.getElementById('actionType');
            const reason = document.getElementById('reason');
            const spareParts = document.getElementById('spareParts');
            const sparePartsGroup = document.getElementById('sparePartsGroup');
            const notificationContainer = document.getElementById('notificationContainer');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const machineFilter = document.getElementById('machineFilter');
            const actionFilter = document.getElementById('actionFilter');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const clearDateFilter = document.getElementById('clearDateFilter');
            const addSparePartBtn = document.getElementById('addSparePartBtn');
            const sparePartModal = document.getElementById('sparePartModal');
            const spareModalTitle = document.getElementById('spareModalTitle');
            const spareModalClose = document.getElementById('spareModalClose');
            const sparePartForm = document.getElementById('sparePartForm');
            const spareDescription = document.getElementById('spareDescription');
            const spareCompatibility = document.getElementById('spareCompatibility');
            const spareQuantity = document.getElementById('spareQuantity');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const spareImageInput = document.getElementById('spareImageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const spareCancelBtn = document.getElementById('spareCancelBtn');
            const spareSaveBtn = document.getElementById('spareSaveBtn');
            const addStockModal = document.getElementById('addStockModal');
            const stockModalTitle = document.getElementById('stockModalTitle');
            const stockModalClose = document.getElementById('stockModalClose');
            const addStockForm = document.getElementById('addStockForm');
            const stockSpareName = document.getElementById('stockSpareName');
            const stockCurrentQuantity = document.getElementById('stockCurrentQuantity');
            const stockAddQuantity = document.getElementById('stockAddQuantity');
            const stockCancelBtn = document.getElementById('stockCancelBtn');

            // Setup event listeners
            setupEventListeners();
            
            // Start the app
            startApp();
        }

        // Start the application
        async function startApp() {
            updateDate();
            await loadState();
            renderMachines();
            renderSpareParts();
            renderHistory();
            updateMachineFilter();
        }

        // Update current date
        function updateDate() {
            const dateElement = document.getElementById('currentDate');
            const today = new Date();
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            dateElement.textContent = today.toLocaleDateString('es-ES', options);
        }

        // Load state from API
        async function loadState() {
            try {
                const data = await apiCall('/api/state');
                if (data) {
                    Object.keys(data).forEach(key => {
                        if (key === 'machines') {
                            Object.keys(data[key]).forEach(machineId => {
                                if (state.machines[machineId]) {
                                    state.machines[machineId] = {
                                        ...state.machines[machineId],
                                        ...data[key][machineId]
                                    };
                                }
                            });
                        } else {
                            state[key] = data[key];
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        // Save state to API
        async function saveState() {
            try {
                await apiCall('/api/state', 'PUT', state);
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Modal controls
            document.getElementById('modalClose').addEventListener('click', closeComponentModal);
            document.getElementById('cancelBtn').addEventListener('click', closeComponentModal);
            document.getElementById('componentForm').addEventListener('submit', handleComponentAction);

            // Spare parts modal
            document.getElementById('addSparePartBtn').addEventListener('click', openSparePartModal);
            document.getElementById('spareModalClose').addEventListener('click', closeSparePartModal);
            document.getElementById('spareCancelBtn').addEventListener('click', closeSparePartModal);
            document.getElementById('sparePartForm').addEventListener('submit', handleSparePartSubmit);
            document.getElementById('imageUploadArea').addEventListener('click', () => {
                document.getElementById('spareImageInput').click();
            });
            document.getElementById('spareImageInput').addEventListener('change', handleImageUpload);

            // Add stock modal
            document.getElementById('stockModalClose').addEventListener('click', closeAddStockModal);
            document.getElementById('stockCancelBtn').addEventListener('click', closeAddStockModal);
            document.getElementById('addStockForm').addEventListener('submit', handleAddStock);

            // Export PDF
            document.getElementById('exportPdfBtn').addEventListener('click', promptInspectorName);

            // History filters
            document.getElementById('machineFilter').addEventListener('change', renderHistory);
            document.getElementById('actionFilter').addEventListener('change', renderHistory);
            document.getElementById('startDate').addEventListener('change', renderHistory);
            document.getElementById('endDate').addEventListener('change', renderHistory);
            document.getElementById('clearDateFilter').addEventListener('click', clearDateFilters);

            // Close modals when clicking outside
            document.getElementById('componentModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('componentModal')) {
                    closeComponentModal();
                }
            });

            document.getElementById('sparePartModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('sparePartModal')) {
                    closeSparePartModal();
                }
            });

            document.getElementById('addStockModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('addStockModal')) {
                    closeAddStockModal();
                }
            });
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Calculate machine status
        function calculateMachineStatus(machine) {
            if (!machine.operational) {
                return {
                    status: 'Apagada',
                    percentage: 0,
                    class: 'status-critical'
                };
            }

            let activeCount = 0;
            let totalCount = 0;

            if (machine.type === 'SEGMENT_BASED') {
                totalCount = machine.segments.length + 1; // +1 for vibration pump
                activeCount = machine.segments.filter(s => s.active).length + (machine.vibrationPump.active ? 1 : 0);
            } else if (machine.type === 'DEVICE_BASED' || machine.type === 'GRID_BASED') {
                totalCount = machine.devices.length;
                activeCount = machine.devices.filter(d => d.active).length;
            } else if (machine.type === 'SIMPLE') {
                totalCount = 1;
                activeCount = 1;
            }

            const percentage = Math.round((activeCount / totalCount) * 100);
            let status, statusClass;

            if (percentage === 100) {
                status = 'Operativo';
                statusClass = 'status-operational';
            } else if (percentage >= 75) {
                status = 'Operativo';
                statusClass = 'status-operational';
            } else if (percentage >= 50) {
                status = 'Parcial';
                statusClass = 'status-partial';
            } else {
                status = 'Crítico';
                statusClass = 'status-critical';
            }

            return {
                status,
                percentage,
                class: statusClass
            };
        }

        // Render machines
        function renderMachines() {
            const machinesContainer = document.getElementById('machinesContainer');
            machinesContainer.innerHTML = '';

            Object.values(state.machines).forEach(machine => {
                const status = calculateMachineStatus(machine);
                const machineCard = document.createElement('div');
                machineCard.className = 'machine-card';
                machineCard.id = `machine-${machine.id}`;

                machineCard.innerHTML = `
                    <div class="machine-header">
                        <div class="machine-name">${machine.name}</div>
                        <div class="machine-status">
                            <div class="status-indicator ${status.class}"></div>
                            <span>${status.status} (${status.percentage}%)</span>
                        </div>
                        <button class="machine-toggle ${machine.operational ? 'active' : ''}" data-machine-id="${machine.id}">
                            ${machine.operational ? 'Encendida' : 'Apagada'}
                        </button>
                    </div>
                    <div class="machine-body ${machine.operational ? 'active' : ''}">
                        ${renderMachineContent(machine)}
                    </div>
                `;

                machinesContainer.appendChild(machineCard);
            });

            // Add event listeners to machine toggles
            document.querySelectorAll('.machine-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    const machineId = e.target.getAttribute('data-machine-id');
                    toggleMachine(machineId);
                });
            });

            // Add event listeners to machine components
            addMachineComponentListeners();
        }

        // Render machine content based on type
        function renderMachineContent(machine) {
            if (machine.type === 'SEGMENT_BASED') {
                return renderSegmentMachine(machine);
            } else if (machine.type === 'DEVICE_BASED') {
                return renderDeviceMachine(machine);
            } else if (machine.type === 'GRID_BASED') {
                return renderGridMachine(machine);
            } else if (machine.type === 'SIMPLE') {
                return renderSimpleMachine(machine);
            }
            return '';
        }

        // Render segment-based machine
        function renderSegmentMachine(machine) {
            return `
                <div class="segment-machine">
                    <svg class="segment-svg" width="300" height="300" viewBox="0 0 300 300">
                        ${machine.segments.slice(0, 14).map((segment, index) => {
                            const startAngle = (index * 360 / 14) - 90;
                            const endAngle = ((index + 1) * 360 / 14) - 90;
                            const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;
                            
                            const x1 = 150 + 120 * Math.cos(startAngle * Math.PI / 180);
                            const y1 = 150 + 120 * Math.sin(startAngle * Math.PI / 180);
                            const x2 = 150 + 120 * Math.cos(endAngle * Math.PI / 180);
                            const y2 = 150 + 120 * Math.sin(endAngle * Math.PI / 180);
                            
                            const x3 = 150 + 80 * Math.cos(endAngle * Math.PI / 180);
                            const y3 = 150 + 80 * Math.sin(endAngle * Math.PI / 180);
                            const x4 = 150 + 80 * Math.cos(startAngle * Math.PI / 180);
                            const y4 = 150 + 80 * Math.sin(startAngle * Math.PI / 180);
                            
                            return `
                                <path class="segment ${segment.active ? 'active' : 'inactive'}" 
                                    d="M ${x1} ${y1} A 120 120 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x3} ${y3} A 80 80 0 ${largeArcFlag} 0 ${x4} ${y4} Z"
                                    data-machine-id="${machine.id}" 
                                    data-component-id="${segment.id}" 
                                    data-component-type="segment">
                                </path>
                            `;
                        }).join('')}
                        
                        ${machine.segments.slice(14).map((segment, index) => {
                            const startAngle = (index * 360 / 14) - 90;
                            const endAngle = ((index + 1) * 360 / 14) - 90;
                            const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;
                            
                            const x1 = 150 + 70 * Math.cos(startAngle * Math.PI / 180);
                            const y1 = 150 + 70 * Math.sin(startAngle * Math.PI / 180);
                            const x2 = 150 + 70 * Math.cos(endAngle * Math.PI / 180);
                            const y2 = 150 + 70 * Math.sin(endAngle * Math.PI / 180);
                            
                            const x3 = 150 + 30 * Math.cos(endAngle * Math.PI / 180);
                            const y3 = 150 + 30 * Math.sin(endAngle * Math.PI / 180);
                            const x4 = 150 + 30 * Math.cos(startAngle * Math.PI / 180);
                            const y4 = 150 + 30 * Math.sin(startAngle * Math.PI / 180);
                            
                            return `
                                <path class="segment ${segment.active ? 'active' : 'inactive'}" 
                                    d="M ${x1} ${y1} A 70 70 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x3} ${y3} A 30 30 0 ${largeArcFlag} 0 ${x4} ${y4} Z"
                                    data-machine-id="${machine.id}" 
                                    data-component-id="${segment.id}" 
                                    data-component-type="segment">
                                </path>
                            `;
                        }).join('')}
                        
                        <circle class="vibration-center ${machine.vibrationPump.active ? 'active' : 'inactive'}" 
                            cx="150" cy="150" r="25"
                            data-machine-id="${machine.id}" 
                            data-component-id="VibP" 
                            data-component-type="vibp">
                        </circle>
                        
                        ${machine.segments.slice(0, 14).map((segment, index) => {
                            const angle = (index * 360 / 14) - 90 + (180 / 14);
                            const x = 150 + 100 * Math.cos(angle * Math.PI / 180);
                            const y = 150 + 100 * Math.sin(angle * Math.PI / 180);
                            return `<text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#333">${segment.id}</text>`;
                        }).join('')}
                        
                        ${machine.segments.slice(14).map((segment, index) => {
                            const angle = (index * 360 / 14) - 90 + (180 / 14);
                            const x = 150 + 50 * Math.cos(angle * Math.PI / 180);
                            const y = 150 + 50 * Math.sin(angle * Math.PI / 180);
                            return `<text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" font-size="8" fill="#333">${segment.id}</text>`;
                        }).join('')}
                        
                        <text x="150" y="150" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#333">VibP</text>
                    </svg>
                </div>
            `;
        }

        // Render device-based machine
        function renderDeviceMachine(machine) {
            return `
                <div class="device-grid">
                    ${machine.devices.map(device => `
                        <div class="device-box ${device.active ? 'active' : 'inactive'}" 
                            data-machine-id="${machine.id}" 
                            data-component-id="${device.id}" 
                            data-component-type="device">
                            <i class="fas fa-${getDeviceIcon(device.id)}"></i>
                            <span>${device.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render grid-based machine
        function renderGridMachine(machine) {
            return `
                <div class="parts-grid">
                    ${machine.devices.map(device => `
                        <div class="part-card">
                            <div class="part-header">
                                <div class="part-name">${device.name}</div>
                                <div class="part-status ${device.active ? 'status-operational' : 'status-critical'}"></div>
                            </div>
                            <div class="part-details">
                                <div class="part-device">
                                    <span>Estado</span>
                                    <div class="device-toggle ${device.active ? 'active' : ''}" 
                                        data-machine-id="${machine.id}" 
                                        data-component-id="${device.id}" 
                                        data-component-type="device">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render simple machine
        function renderSimpleMachine(machine) {
            return `
                <div class="simple-machine">
                    <div class="simple-status">Estado: ${machine.operational ? 'Operativo' : 'Apagado'}</div>
                    <button class="simple-toggle ${machine.operational ? 'active' : ''}" 
                        data-machine-id="${machine.id}" 
                        data-component-id="status" 
                        data-component-type="simple">
                        ${machine.operational ? 'Apagar' : 'Encender'}
                    </button>
                </div>
            `;
        }

        // Get device icon based on device ID
        function getDeviceIcon(deviceId) {
            const icons = {
                cuchillo: 'cut',
                impresora: 'print',
                neumatico: 'wind',
                insumos: 'box',
                'cuerpo-control': 'microchip',
                ev: 'valve',
                'generador-vacio': 'fan',
                tubing: 'pipe'
            };
            return icons[deviceId] || 'cog';
        }

        // Add event listeners to machine components
        function addMachineComponentListeners() {
            // Segment and vibration pump listeners
            document.querySelectorAll('.segment, .vibration-center').forEach(element => {
                element.addEventListener('click', (e) => {
                    const machineId = e.target.getAttribute('data-machine-id');
                    const componentId = e.target.getAttribute('data-component-id');
                    const componentType = e.target.getAttribute('data-component-type');
                    
                    toggleComponent(machineId, componentId, componentType);
                    openComponentModal(machineId, componentId, componentType);
                });
            });

            // Device and toggle listeners
            document.querySelectorAll('.device-box, .device-toggle, .simple-toggle').forEach(element => {
                element.addEventListener('click', (e) => {
                    const machineId = e.currentTarget.getAttribute('data-machine-id');
                    const componentId = e.currentTarget.getAttribute('data-component-id');
                    const componentType = e.currentTarget.getAttribute('data-component-type');
                    
                    if (componentType === 'simple') {
                        toggleSimpleMachine(machineId);
                    } else {
                        toggleDevice(machineId, componentId);
                        openComponentModal(machineId, componentId, componentType);
                    }
                });
            });
        }

        // Toggle segment or vibration pump
        function toggleComponent(machineId, componentId, componentType) {
            const machine = state.machines[machineId];
            
            if (componentType === 'segment') {
                const segment = machine.segments.find(s => s.id === componentId);
                if (segment) {
                    segment.active = !segment.active;
                    const element = document.querySelector(`[data-machine-id="${machineId}"][data-component-id="${componentId}"]`);
                    if (element) {
                        element.classList.toggle('active');
                        element.classList.toggle('inactive');
                    }
                }
            } else if (componentType === 'vibp') {
                machine.vibrationPump.active = !machine.vibrationPump.active;
                const element = document.querySelector(`[data-machine-id="${machineId}"][data-component-id="${componentId}"]`);
                if (element) {
                    element.classList.toggle('active');
                    element.classList.toggle('inactive');
                }
            }
            
            // Update machine status
            const status = calculateMachineStatus(machine);
            const machineCard = document.getElementById(`machine-${machineId}`);
            const statusIndicator = machineCard.querySelector('.status-indicator');
            const statusText = machineCard.querySelector('.machine-status span');
            
            statusIndicator.className = `status-indicator ${status.class}`;
            statusText.textContent = `${status.status} (${status.percentage}%)`;
            
            saveState();
        }

        // Toggle machine on/off
        function toggleMachine(machineId) {
            const machine = state.machines[machineId];
            machine.operational = !machine.operational;
            
            const machineCard = document.getElementById(`machine-${machineId}`);
            const toggleButton = machineCard.querySelector('.machine-toggle');
            const machineBody = machineCard.querySelector('.machine-body');
            
            toggleButton.classList.toggle('active');
            toggleButton.textContent = machine.operational ? 'Encendida' : 'Apagada';
            machineBody.classList.toggle('active');
            
            // Update machine status
            const status = calculateMachineStatus(machine);
            const statusIndicator = machineCard.querySelector('.status-indicator');
            const statusText = machineCard.querySelector('.machine-status span');
            
            statusIndicator.className = `status-indicator ${status.class}`;
            statusText.textContent = `${status.status} (${status.percentage}%)`;
            
            saveState();
            showNotification(
                machine.operational ? 'success' : 'warning',
                'Máquina Actualizada',
                `${machine.name} ha sido ${machine.operational ? 'encendida' : 'apagada'}`
            );
        }

        // Toggle device
        function toggleDevice(machineId, deviceId) {
            const machine = state.machines[machineId];
            const device = machine.devices.find(d => d.id === deviceId);
            
            if (device) {
                device.active = !device.active;
                const element = document.querySelector(`[data-machine-id="${machineId}"][data-component-id="${deviceId}"]`);
                
                if (element) {
                    if (machine.id === 'bolsas') {
                        // For device-based machines, update the box class
                        element.classList.remove('active', 'inactive');
                        element.classList.add(device.active ? 'active' : 'inactive');
                    } else {
                        // For grid-based machines, update the toggle
                        element.classList.toggle('active');
                    }
                }
                
                // Update machine status
                const status = calculateMachineStatus(machine);
                const machineCard = document.getElementById(`machine-${machineId}`);
                const statusIndicator = machineCard.querySelector('.status-indicator');
                const statusText = machineCard.querySelector('.machine-status span');
                
                statusIndicator.className = `status-indicator ${status.class}`;
                statusText.textContent = `${status.status} (${status.percentage}%)`;
                
                saveState();
            }
        }

        // Toggle simple machine
        function toggleSimpleMachine(machineId) {
            const machine = state.machines[machineId];
            machine.operational = !machine.operational;
            
            const machineCard = document.getElementById(`machine-${machineId}`);
            const toggleButton = machineCard.querySelector('.simple-toggle');
            const statusText = machineCard.querySelector('.simple-status');
            
            toggleButton.classList.toggle('active');
            toggleButton.textContent = machine.operational ? 'Apagar' : 'Encender';
            statusText.textContent = `Estado: ${machine.operational ? 'Operativo' : 'Apagado'}`;
            
            // Update machine status
            const status = calculateMachineStatus(machine);
            const statusIndicator = machineCard.querySelector('.status-indicator');
            const statusTextHeader = machineCard.querySelector('.machine-status span');
            
            statusIndicator.className = `status-indicator ${status.class}`;
            statusTextHeader.textContent = `${status.status} (${status.percentage}%)`;
            
            saveState();
            showNotification(
                machine.operational ? 'success' : 'warning',
                'Máquina Actualizada',
                `${machine.name} ha sido ${machine.operational ? 'encendida' : 'apagada'}`
            );
        }

        // Open component modal
        function openComponentModal(machineId, componentId, componentType) {
            const machine = state.machines[machineId];
            let component = null;
            
            if (componentType === 'segment') {
                component = machine.segments.find(s => s.id === componentId);
            } else if (componentType === 'vibp') {
                component = machine.vibrationPump;
            } else if (componentType === 'device') {
                component = machine.devices.find(d => d.id === componentId);
            } else if (componentType === 'simple') {
                component = { id: 'status', name: 'Estado General' };
            }
            
            if (component) {
                state.currentComponent = {
                    machineId,
                    componentId,
                    componentType,
                    componentName: component.name || componentId
                };
                
                document.getElementById('modalTitle').textContent = `Acción: ${machine.name} - ${component.name || componentId}`;
                document.getElementById('componentName').value = component.name || componentId;
                
                updateSparePartsOptions(machineId, componentId);
                document.getElementById('componentModal').classList.add('active');
            }
        }

        // Update spare parts options based on machine and component
        function updateSparePartsOptions(machineId, componentId) {
            const sparePartsSelect = document.getElementById('spareParts');
            sparePartsSelect.innerHTML = '<option value="">Ninguno</option>';
            
            const compatibleParts = state.spareParts.filter(part => {
                if (part.compatibility === 'S/T/U' && (machineId === 'S' || machineId === 'T' || machineId === 'U')) {
                    return true;
                }
                if (part.compatibility === 'R' && machineId === 'R') {
                    return true;
                }
                if (part.compatibility === 'W' && machineId === 'W') {
                    return true;
                }
                if (part.compatibility === 'Máq Bolsas' && machineId === 'bolsas') {
                    return true;
                }
                if (part.compatibility === 'Alineador Mag' && machineId === 'alineador') {
                    return true;
                }
                if (part.compatibility === 'Sist Neumáticos' && machineId.includes('neumaticos')) {
                    return true;
                }
                if (part.compatibility === 'Otros') {
                    return true;
                }
                return false;
            });
            
            compatibleParts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = `${part.description} (Stock: ${part.quantity})`;
                sparePartsSelect.appendChild(option);
            });
            
            // Show/hide spare parts group based on action type
            const actionTypeSelect = document.getElementById('actionType');
            actionTypeSelect.addEventListener('change', () => {
                if (actionTypeSelect.value === 'repair') {
                    document.getElementById('sparePartsGroup').style.display = 'block';
                } else {
                    document.getElementById('sparePartsGroup').style.display = 'none';
                }
            });
            
            // Initial state
            if (actionTypeSelect.value === 'repair') {
                document.getElementById('sparePartsGroup').style.display = 'block';
            } else {
                document.getElementById('sparePartsGroup').style.display = 'none';
            }
        }

        // Close component modal
        function closeComponentModal() {
            document.getElementById('componentModal').classList.remove('active');
            document.getElementById('componentForm').reset();
            state.currentComponent = null;
        }

        // Handle component action form submission
        function handleComponentAction(e) {
            e.preventDefault();
            
            if (!state.currentComponent) return;
            
            const { machineId, componentId, componentType, componentName } = state.currentComponent;
            const action = document.getElementById('actionType').value;
            const reasonText = document.getElementById('reason').value;
            const sparePartId = document.getElementById('spareParts').value;
            
            // Create history record
            const now = new Date();
            const historyRecord = {
                id: `h${Date.now()}`,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                machine: machineId,
                component: componentId,
                action: action,
                reason: reasonText,
                sparePart: sparePartId || null
            };
            
            // Add to history
            state.history.unshift(historyRecord);
            
            // Update spare part quantity if used
            if (sparePartId) {
                const sparePart = state.spareParts.find(p => p.id === sparePartId);
                if (sparePart && sparePart.quantity > 0) {
                    sparePart.quantity--;
                }
            }
            
            saveState();
            renderHistory();
            renderSpareParts();
            
            showNotification(
                'success',
                action === 'repair' ? 'Reparación' : 'Mantenimiento',
                `Se ha registrado una ${action === 'repair' ? 'reparación' : 'mantenimiento'} para ${componentName}`
            );
            
            closeComponentModal();
        }

        // Open spare part modal
        function openSparePartModal() {
            state.editSparePart = false;
            state.currentSparePart = null;
            document.getElementById('spareModalTitle').textContent = 'Nuevo Repuesto';
            document.getElementById('sparePartForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('sparePartModal').classList.add('active');
        }

        // Open edit spare part modal
        function openEditSparePartModal(sparePartId) {
            const sparePart = state.spareParts.find(p => p.id === sparePartId);
            if (!sparePart) return;
            
            state.editSparePart = true;
            state.currentSparePart = sparePart;
            document.getElementById('spareModalTitle').textContent = 'Editar Repuesto';
            document.getElementById('spareDescription').value = sparePart.description;
            document.getElementById('spareCompatibility').value = sparePart.compatibility;
            document.getElementById('spareQuantity').value = sparePart.quantity;
            
            if (sparePart.image) {
                document.getElementById('previewImage').src = sparePart.image;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
            
            document.getElementById('sparePartModal').classList.add('active');
        }

        // Close spare part modal
        function closeSparePartModal() {
            document.getElementById('sparePartModal').classList.remove('active');
            document.getElementById('sparePartForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            state.currentSparePart = null;
            state.editSparePart = false;
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Resize image if needed
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('previewImage').src = dataUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Handle spare part form submission
        function handleSparePartSubmit(e) {
            e.preventDefault();
            
            const description = document.getElementById('spareDescription').value;
            const compatibility = document.getElementById('spareCompatibility').value;
            const quantity = parseInt(document.getElementById('spareQuantity').value);
            const image = document.getElementById('previewImage').src || '';
            
            if (state.editSparePart && state.currentSparePart) {
                // Update existing spare part
                state.currentSparePart.description = description;
                state.currentSparePart.compatibility = compatibility;
                state.currentSparePart.quantity = quantity;
                state.currentSparePart.image = image;
                
                showNotification('success', 'Repuesto Actualizado', 'El repuesto ha sido actualizado correctamente.');
            } else {
                // Create new spare part
                const newSparePart = {
                    id: `sp${Date.now()}`,
                    description,
                    compatibility,
                    quantity,
                    image
                };
                
                state.spareParts.push(newSparePart);
                showNotification('success', 'Repuesto Creado', 'El repuesto ha sido creado correctamente.');
            }
            
            saveState();
            renderSpareParts();
            closeSparePartModal();
        }

        // Delete spare part
        function deleteSparePart(sparePartId) {
            if (confirm('¿Está seguro que quiere borrar el repuesto?')) {
                state.spareParts = state.spareParts.filter(p => p.id !== sparePartId);
                saveState();
                renderSpareParts();
                showNotification('success', 'Repuesto Eliminado', 'El repuesto ha sido eliminado correctamente.');
            }
        }

        // Open add stock modal
        function openAddStockModal(sparePartId) {
            const sparePart = state.spareParts.find(p => p.id === sparePartId);
            if (!sparePart) return;
            
            state.currentSparePart = sparePart;
            document.getElementById('stockSpareName').value = sparePart.description;
            document.getElementById('stockCurrentQuantity').value = sparePart.quantity;
            document.getElementById('stockAddQuantity').value = '';
            document.getElementById('addStockModal').classList.add('active');
        }

        // Close add stock modal
        function closeAddStockModal() {
            document.getElementById('addStockModal').classList.remove('active');
            document.getElementById('addStockForm').reset();
            state.currentSparePart = null;
        }

        // Handle add stock form submission
        function handleAddStock(e) {
            e.preventDefault();
            
            if (!state.currentSparePart) return;
            
            const quantityToAdd = parseInt(document.getElementById('stockAddQuantity').value);
            if (quantityToAdd > 0) {
                state.currentSparePart.quantity += quantityToAdd;
                saveState();
                renderSpareParts();
                
                showNotification(
                    'success',
                    'Stock Actualizado',
                    `Se han añadido ${quantityToAdd} unidades a ${state.currentSparePart.description}`
                );
                
                closeAddStockModal();
            }
        }

        // Render spare parts as a list
        function renderSpareParts() {
            // Clear existing items except header
            const header = document.querySelector('.spare-list-header');
            const container = document.getElementById('sparePartsContainer');
            container.innerHTML = '';
            container.appendChild(header);
            
            state.spareParts.forEach(sparePart => {
                let quantityClass = '';
                if (sparePart.quantity <= 2) {
                    quantityClass = 'low';
                } else if (sparePart.quantity <= 5) {
                    quantityClass = 'medium';
                }
                
                const spareListItem = document.createElement('div');
                spareListItem.className = 'spare-list-item';
                
                spareListItem.innerHTML = `
                    <div class="spare-name">${sparePart.description}</div>
                    <div class="spare-compatibility">${sparePart.compatibility}</div>
                    <div>
                        <span class="quantity-badge ${quantityClass}">${sparePart.quantity}</span>
                    </div>
                    <div>
                        ${sparePart.image ? `<img src="${sparePart.image}" alt="${sparePart.description}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 'Sin imagen'}
                    </div>
                    <div class="spare-actions">
                        <button class="edit-spare-btn" data-spare-id="${sparePart.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="add-stock-btn" data-spare-id="${sparePart.id}">
                            <i class="fas fa-plus"></i> Stock
                        </button>
                        <button class="delete-spare-btn" data-spare-id="${sparePart.id}">
                            <i class="fas fa-trash"></i> Borrar
                        </button>
                    </div>
                `;
                
                container.appendChild(spareListItem);
            });
            
            // Add event listeners to spare part buttons
            document.querySelectorAll('.edit-spare-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sparePartId = e.currentTarget.getAttribute('data-spare-id');
                    openEditSparePartModal(sparePartId);
                });
            });
            
            document.querySelectorAll('.add-stock-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sparePartId = e.currentTarget.getAttribute('data-spare-id');
                    openAddStockModal(sparePartId);
                });
            });
            
            document.querySelectorAll('.delete-spare-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sparePartId = e.currentTarget.getAttribute('data-spare-id');
                    deleteSparePart(sparePartId);
                });
            });
        }

        // Clear date filters
        function clearDateFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            renderHistory();
        }

        // Render history
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const machineFilterValue = document.getElementById('machineFilter').value;
            const actionFilterValue = document.getElementById('actionFilter').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;
            
            let filteredHistory = state.history;
            
            // Filter by machine
            if (machineFilterValue !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.machine === machineFilterValue);
            }
            
            // Filter by action
            if (actionFilterValue !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.action === actionFilterValue);
            }
            
            // Filter by date range
            if (startDateValue) {
                filteredHistory = filteredHistory.filter(record => record.date >= startDateValue);
            }
            
            if (endDateValue) {
                filteredHistory = filteredHistory.filter(record => record.date <= endDateValue);
            }
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<div class="history-item">No hay registros que coincidan con los filtros seleccionados.</div>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const machine = state.machines[record.machine];
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${record.action === 'failure' ? 'danger' : 'success'}`;
                
                // Format component name
                let componentName = '';
                if (record.component === 'VibP') {
                    componentName = 'VibP (Centro)';
                } else if (record.component === 'status') {
                    componentName = 'Estado General';
                } else {
                    componentName = record.component;
                }
                
                // Format action
                let actionClass = '';
                let actionText = '';
                if (record.action === 'repair') {
                    actionClass = 'repair';
                    actionText = 'Reparación';
                } else if (record.action === 'maintenance') {
                    actionClass = 'maintenance';
                    actionText = 'Mantenimiento';
                }
                
                historyItem.innerHTML = `
                    <div class="history-details">
                        <div class="history-date">${record.date} ${record.time}</div>
                        <div class="history-machine">${machine?.name || record.machine}</div>
                        <div class="history-component">Componente: ${componentName}</div>
                        <div class="history-action">Acción: ${actionText}</div>
                        <div class="history-reason">Motivo: ${record.reason}</div>
                    </div>
                    <div class="history-status">
                        <span class="status-badge ${actionClass}">${actionText}</span>
                        <button class="expand-btn" data-record-id="${record.id}">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="history-expanded" id="expanded-${record.id}">
                        <div class="expanded-content">
                            <div class="expanded-item">
                                <div class="expanded-label">ID de Registro</div>
                                <div class="expanded-value">${record.id}</div>
                            </div>
                            <div class="expanded-item">
                                <div class="expanded-label">ID de Máquina</div>
                                <div class="expanded-value">${record.machine}</div>
                            </div>
                            <div class="expanded-item">
                                <div class="expanded-label">ID de Componente</div>
                                <div class="expanded-value">${record.component}</div>
                            </div>
                            <div class="expanded-item">
                                <div class="expanded-label">Repuesto Utilizado</div>
                                <div class="expanded-value">${record.sparePart ? getSparePartName(record.sparePart) : 'Ninguno'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            // Add event listeners to expand buttons
            document.querySelectorAll('.expand-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.currentTarget.getAttribute('data-record-id');
                    const expandedContent = document.getElementById(`expanded-${recordId}`);
                    const icon = e.currentTarget.querySelector('i');
                    
                    expandedContent.classList.toggle('active');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
            });
        }

        // Get spare part name by ID
        function getSparePartName(sparePartId) {
            const sparePart = state.spareParts.find(p => p.id === sparePartId);
            return sparePart ? sparePart.description : 'Desconocido';
        }

        // Update machine filter options
        function updateMachineFilter() {
            const machineFilter = document.getElementById('machineFilter');
            machineFilter.innerHTML = '<option value="all">Todas las máquinas</option>';
            
            Object.values(state.machines).forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = machine.name;
                machineFilter.appendChild(option);
            });
        }

        // Show notification
        function showNotification(type, title, message) {
            const notificationContainer = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let iconClass = '';
            if (type === 'success') {
                iconClass = 'fa-check-circle';
            } else if (type === 'error') {
                iconClass = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                iconClass = 'fa-exclamation-triangle';
            }
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Add close button event listener
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Prompt for inspector name before exporting PDF
        function promptInspectorName() {
            const inspectorName = prompt('Por favor, ingrese el nombre del inspector:');
            if (inspectorName !== null && inspectorName.trim() !== '') {
                exportToPDF(inspectorName.trim());
            }
        }

        // Helper function to safely add text to PDF
        function safeAddText(pdf, text, x, y, options = {}) {
            if (!text || typeof text !== 'string') {
                text = '';
            }
            
            // Truncate text if it's too long
            const maxLength = 30;
            if (text.length > maxLength) {
                text = text.substring(0, maxLength) + '...';
            }
            
            try {
                pdf.text(text, x, y, options);
            } catch (error) {
                console.error('Error adding text to PDF:', error);
                // Try with a simpler approach if the first attempt fails
                try {
                    pdf.text(text || '', x, y);
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                }
            }
        }

        // Export to PDF with inspector name and recent movements
        function exportToPDF(inspectorName) {
            showNotification('success', 'Generando PDF', 'El documento PDF se está generando. Por favor, espere...');
            
            const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
            
            // Create a temporary container for the export
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '1200px';
            document.body.appendChild(tempContainer);
            
            // Clone the header
            const headerClone = document.querySelector('header').cloneNode(true);
            tempContainer.appendChild(headerClone);
            
            // Clone the active tab content
            const tabContentClone = document.getElementById(`${activeTab}-tab`).cloneNode(true);
            tempContainer.appendChild(tabContentClone);
            
            // Use html2canvas to capture the content with maximum compression
            html2canvas(tempContainer, {
                scale: 0.8, // Reduced scale for smaller file size
                useCORS: true,
                allowTaint: true,
                logging: false,
                imageTimeout: 0,
                removeContainer: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.5); // Lower quality for smaller file size
                
                const pdfWidth = 210;
                const pdfHeight = 295;
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 30;
                
                // Add title
                pdf.setFontSize(16);
                safeAddText(pdf, 'Panel de Control de Máquinas Automáticas', 105, 15, { align: 'center' });
                
                // Add date
                pdf.setFontSize(10);
                const now = new Date();
                safeAddText(pdf, `Fecha: ${now.toLocaleDateString('es-ES')} ${now.toLocaleTimeString('es-ES')}`, 105, 22, { align: 'center' });
                
                // Add inspector name
                safeAddText(pdf, `Reporte generado por: ${inspectorName}`, 105, 29, { align: 'center' });
                
                // Add image
                pdf.addImage(imgData, 'JPEG', imgX, imgY + 5, imgWidth * ratio, imgHeight * ratio);
                
                // Add new page for recent movements
                pdf.addPage();
                
                // Add title for recent movements
                pdf.setFontSize(14);
                safeAddText(pdf, 'Movimientos últimos 5 días', 105, 20, { align: 'center' });
                
                // Get date 5 days ago
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                const fiveDaysAgoStr = fiveDaysAgo.toISOString().split('T')[0];
                
                // Filter history for last 5 days
                const recentHistory = state.history.filter(record => record.date >= fiveDaysAgoStr);
                
                // Create table for recent movements
                let yPos = 35;
                pdf.setFontSize(10);
                
                // Table headers
                pdf.setFillColor(200, 200, 200);
                pdf.rect(20, yPos, 170, 10, 'F');
                safeAddText(pdf, 'Día', 25, yPos + 7);
                safeAddText(pdf, 'Movimiento', 55, yPos + 7);
                safeAddText(pdf, 'Máquina', 110, yPos + 7);
                safeAddText(pdf, 'Repuesto', 150, yPos + 7);
                
                yPos += 15;
                
                // Table rows
                recentHistory.forEach(record => {
                    // Check if we have enough space for another row
                    if (yPos > 270) {
                        pdf.addPage();
                        yPos = 20;
                        
                        // Add headers again on new page
                        pdf.setFillColor(200, 200, 200);
                        pdf.rect(20, yPos, 170, 10, 'F');
                        safeAddText(pdf, 'Día', 25, yPos + 7);
                        safeAddText(pdf, 'Movimiento', 55, yPos + 7);
                        safeAddText(pdf, 'Máquina', 110, yPos + 7);
                        safeAddText(pdf, 'Repuesto', 150, yPos + 7);
                        
                        yPos += 15;
                    }
                    
                    // Alternate row colors based on action type
                    if (record.action === 'repair') {
                        pdf.setFillColor(255, 200, 200); // Light red for repairs
                    } else {
                        pdf.setFillColor(200, 255, 200); // Light green for maintenance
                    }
                    pdf.rect(20, yPos - 5, 170, 10, 'F');
                    
                    // Format date
                    const date = new Date(record.date);
                    const dayStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                    
                    // Format action
                    const actionText = record.action === 'repair' ? 'Reparación' : 'Mantenimiento';
                    
                    // Get machine name
                    const machine = state.machines[record.machine];
                    const machineName = machine ? machine.name : record.machine;
                    
                    // Get spare part name
                    const sparePartName = record.sparePart ? getSparePartName(record.sparePart) : 'N/A';
                    
                    // Add row data with safe text function
                    safeAddText(pdf, dayStr, 25, yPos);
                    safeAddText(pdf, actionText, 55, yPos);
                    safeAddText(pdf, machineName, 110, yPos);
                    safeAddText(pdf, sparePartName, 150, yPos);
                    
                    yPos += 10;
                });
                
                // Save the PDF
                pdf.save(`panel-control-${activeTab}-${now.toISOString().split('T')[0]}.pdf`);
                
                // Clean up
                document.body.removeChild(tempContainer);
                
                showNotification('success', 'PDF Exportado', 'El documento PDF ha sido generado correctamente.');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                document.body.removeChild(tempContainer);
                showNotification('error', 'Error', 'No se pudo generar el PDF. Inténtelo de nuevo.');
            });
        }

        // Initialize the application
        async function init() {
            if (!authToken) {
                showLoginScreen();
                return;
            }
            
            // Verify token is still valid
            try {
                const data = await apiCall('/api/state');
                if (!data) {
                    showLoginScreen();
                    return;
                }
            } catch (error) {
                showLoginScreen();
                return;
            }
            
            // Show main app
            showMainApp();
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>